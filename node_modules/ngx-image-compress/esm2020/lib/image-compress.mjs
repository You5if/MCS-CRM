var _a;
import { DOC_ORIENTATION } from './models/DOC_ORIENTATION';
export class ImageCompress {
}
_a = ImageCompress;
ImageCompress.getOrientation = (file) => new Promise((resolve, reject) => {
    try {
        const reader = new FileReader();
        reader.onload = () => {
            const view = new DataView(reader.result);
            if (!view.byteLength) {
                return resolve(DOC_ORIENTATION.NotDefined);
            }
            if (view.getUint16(0, false) !== 0xffd8) {
                return resolve(DOC_ORIENTATION.NotDefined);
            }
            const length = view.byteLength;
            let offset = 2;
            while (offset < length) {
                const marker = view.getUint16(offset, false);
                offset += 2;
                if (marker === 0xffe1) {
                    if (view.getUint32((offset += 2), false) !== 0x45786966) {
                        return resolve(DOC_ORIENTATION.NotJpeg);
                    }
                    const little = view.getUint16((offset += 6), false) === 0x4949;
                    offset += view.getUint32(offset + 4, little);
                    const tags = view.getUint16(offset, little);
                    offset += 2;
                    for (let i = 0; i < tags; i++) {
                        if (view.getUint16(offset + i * 12, little) === 0x0112) {
                            return resolve(view.getUint16(offset + i * 12 + 8, little));
                        }
                    }
                }
                else if ((marker & 0xff00) !== 0xff00) {
                    break;
                }
                else {
                    offset += view.getUint16(offset, false);
                }
            }
            return resolve(DOC_ORIENTATION.NotJpeg);
        };
        reader.readAsArrayBuffer(file);
    }
    catch (e) {
        return reject(DOC_ORIENTATION.Default);
    }
});
ImageCompress.uploadFile = (render, multiple = true) => new Promise(function (resolve, reject) {
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    Promise.resolve(isSafari)
        .then((onlyNative) => {
        if (onlyNative) {
            return ImageCompress.generateUploadInputNative(window.document, multiple);
        }
        else {
            return ImageCompress.generateUploadInputRenderer(render, multiple);
        }
    })
        .then((filesList) => {
        const files = filesList ? Array.from(filesList) : [];
        const orientationPromises = files.map((file) => ImageCompress.getOrientation(file));
        const readerPromises = files.map((file) => ImageCompress.fileToDataURL(file));
        let orientationsResult = [];
        Promise.all(orientationPromises)
            .then((orientations) => {
            orientationsResult = orientations;
            return Promise.all(readerPromises);
        })
            .then((readerResult) => {
            if (multiple) {
                const result = readerResult.map((image, index) => ({
                    image,
                    orientation: orientationsResult[index],
                }));
                resolve(result);
            }
            else {
                resolve({
                    image: readerResult[0],
                    orientation: orientationsResult[0],
                });
            }
        });
    });
});
ImageCompress.fileToDataURL = (file) => {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            //myReader.onloadend = (progressEvent: ProgressEvent<FileReader>)
            resolve(e.target.result);
        };
        try {
            reader.readAsDataURL(file);
        }
        catch (e) {
            reject(`ngx-image-compress - probably no file have been selected: ${e}`);
        }
    });
};
ImageCompress.generateUploadInputRenderer = (render, multiple = true) => new Promise((resolve, reject) => {
    const inputElement = render.createElement('input');
    render.setStyle(inputElement, 'display', 'none');
    render.setProperty(inputElement, 'type', 'file');
    render.setProperty(inputElement, 'accept', 'image/*');
    if (multiple) {
        render.setProperty(inputElement, 'multiple', 'true');
    }
    render.listen(inputElement, 'click', ($event) => {
        $event.target.value = '';
    });
    render.listen(inputElement, 'change', ($event) => {
        const files = $event.target.files;
        resolve(files);
    });
    inputElement.click();
});
ImageCompress.generateUploadInputNative = (documentNativeApi, multiple = true) => {
    let lock = false;
    return new Promise((resolve, reject) => {
        const inputElement = documentNativeApi.createElement('input');
        inputElement.id = 'upload-input' + new Date();
        inputElement.style.display = 'none';
        inputElement.setAttribute('type', 'file');
        if (multiple) {
            inputElement.setAttribute('multiple', 'true');
        }
        documentNativeApi.body.appendChild(inputElement);
        inputElement.addEventListener('change', () => {
            lock = true;
            resolve(inputElement.files);
            // remove from dom
            documentNativeApi.body.removeChild(documentNativeApi.getElementById(inputElement.id));
        }, { once: true });
        // file blur
        window.addEventListener('focus', () => {
            setTimeout(() => {
                if (!lock && documentNativeApi.getElementById(inputElement.id)) {
                    reject(new Error('onblur'));
                    // remove from dom
                    documentNativeApi.body.removeChild(documentNativeApi.getElementById(inputElement.id));
                }
            }, 300);
        }, { once: true });
        // open file select box
        inputElement.click();
    });
};
ImageCompress.compress = (imageDataUrlSource, orientation, render, ratio = 50, quality = 50, maxwidth = 0, maxheight = 0) => new Promise(function (resolve, reject) {
    quality = quality / 100;
    ratio = ratio / 100;
    const sourceImage = new Image();
    // important for safari: we need to wait for onload event
    sourceImage.onload = () => {
        const canvas = render.createElement('canvas');
        const ctx = canvas.getContext('2d');
        if (!ctx) {
            return reject(`No canvas context available`);
        }
        let w = sourceImage.naturalWidth;
        let h = sourceImage.naturalHeight;
        if (!CSS.supports('image-orientation', 'from-image')) {
            if (orientation === DOC_ORIENTATION.Right ||
                orientation === DOC_ORIENTATION.Left) {
                const t = w;
                w = h;
                h = t;
            }
        }
        let xratio = maxwidth ? maxwidth / w : 1;
        let yratio = maxheight ? maxheight / h : 1;
        ratio = Math.min(ratio, xratio, yratio);
        canvas.width = w * ratio;
        canvas.height = h * ratio;
        const TO_RADIANS = Math.PI / 180;
        if (CSS.supports('image-orientation', 'from-image') ||
            orientation === DOC_ORIENTATION.Up) {
            ctx.drawImage(sourceImage, 0, 0, canvas.width, canvas.height);
        }
        else if (orientation === DOC_ORIENTATION.Right) {
            ctx.save();
            ctx.rotate(90 * TO_RADIANS);
            ctx.translate(0, -canvas.width);
            ctx.drawImage(sourceImage, 0, 0, canvas.height, canvas.width);
            ctx.restore();
        }
        else if (orientation === DOC_ORIENTATION.Left) {
            ctx.save();
            ctx.rotate(-90 * TO_RADIANS);
            ctx.translate(-canvas.width, 0);
            ctx.drawImage(sourceImage, 0, 0, canvas.height, canvas.width);
            ctx.restore();
        }
        else if (orientation === DOC_ORIENTATION.Down) {
            ctx.save();
            ctx.rotate(180 * TO_RADIANS);
            ctx.translate(-canvas.width, -canvas.height);
            ctx.drawImage(sourceImage, 0, 0, canvas.width, canvas.height);
            ctx.restore();
        }
        else {
            // no orientation value found - same as default UP
            ctx.drawImage(sourceImage, 0, 0, canvas.width, canvas.height);
        }
        const mime = imageDataUrlSource.substr(5, imageDataUrlSource.split(';')[0].length - 5);
        // TODO test on mime
        const result = canvas.toDataURL(mime, quality);
        resolve(result);
    };
    sourceImage.onerror = (e) => reject(e);
    sourceImage.src = imageDataUrlSource;
});
ImageCompress.byteCount = (imgString) => encodeURI(imgString).split(/%..|./).length - 1;
ImageCompress.getImageMaxSize = async (maxSizeMb, debugMode, render) => {
    const MAX_TRIES = 10;
    const bytesToMB = (bytes) => (bytes / 1024 / 1024).toFixed(2);
    if (debugMode) {
        console.debug('NgxImageCompress - Opening upload window');
    }
    let myFile = (await ImageCompress.uploadFile(render, false));
    let compressedFile;
    for (let i = 0; i < MAX_TRIES; i++) {
        const previousSize = ImageCompress.byteCount(myFile.image);
        compressedFile = await ImageCompress.compress(myFile.image, myFile.orientation, render, 50, 100);
        const newSize = ImageCompress.byteCount(compressedFile);
        console.debug('NgxImageCompress -', 'Compression from', bytesToMB(previousSize), 'MB to', bytesToMB(newSize), 'MB');
        if (newSize >= previousSize) {
            if (i === 0) {
                if (debugMode) {
                    console.debug('NgxImageCompress -', "File can't be reduced at all - returning the original", bytesToMB(previousSize), 'MB large');
                }
                throw myFile.image;
            }
            else {
                if (debugMode) {
                    console.debug('NgxImageCompress -', "File can't be reduced more - returning the best we can, which is ", bytesToMB(previousSize), 'MB large');
                }
                throw myFile.image;
            }
        }
        else {
            if (newSize < maxSizeMb * 1024 * 1024) {
                if (debugMode) {
                    console.debug('NgxImageCompress -', 'Here your file', bytesToMB(newSize), 'MB large');
                }
                return compressedFile;
            }
            else if (i === 9) {
                if (debugMode) {
                    console.debug('NgxImageCompress -', "File can't reach the desired size after", MAX_TRIES, 'tries. Returning file ', bytesToMB(previousSize), 'MB large');
                }
                throw myFile.image;
            }
        }
        if (debugMode) {
            console.debug('NgxImageCompress -', 'Reached', bytesToMB(newSize), 'MB large. Trying another time after', i + 1, 'times');
        }
        myFile.image = compressedFile;
    }
    if (debugMode) {
        console.debug('NgxImageCompress - Unexpected error');
    }
    throw '';
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1hZ2UtY29tcHJlc3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtaW1hZ2UtY29tcHJlc3Mvc3JjL2xpYi9pbWFnZS1jb21wcmVzcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBRUEsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBRzNELE1BQU0sT0FBTyxhQUFhOzs7QUFDakIsNEJBQWMsR0FBRyxDQUFDLElBQVUsRUFBNEIsRUFBRSxDQUMvRCxJQUFJLE9BQU8sQ0FBa0IsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7SUFDL0MsSUFBSTtRQUNGLE1BQU0sTUFBTSxHQUFHLElBQUksVUFBVSxFQUFFLENBQUM7UUFDaEMsTUFBTSxDQUFDLE1BQU0sR0FBRyxHQUFHLEVBQUU7WUFDbkIsTUFBTSxJQUFJLEdBQUcsSUFBSSxRQUFRLENBQUMsTUFBTSxDQUFDLE1BQXFCLENBQUMsQ0FBQztZQUN4RCxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRTtnQkFDcEIsT0FBTyxPQUFPLENBQUMsZUFBZSxDQUFDLFVBQVUsQ0FBQyxDQUFDO2FBQzVDO1lBQ0QsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsS0FBSyxNQUFNLEVBQUU7Z0JBQ3ZDLE9BQU8sT0FBTyxDQUFDLGVBQWUsQ0FBQyxVQUFVLENBQUMsQ0FBQzthQUM1QztZQUNELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUM7WUFDL0IsSUFBSSxNQUFNLEdBQUcsQ0FBQyxDQUFDO1lBQ2YsT0FBTyxNQUFNLEdBQUcsTUFBTSxFQUFFO2dCQUN0QixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQztnQkFDN0MsTUFBTSxJQUFJLENBQUMsQ0FBQztnQkFDWixJQUFJLE1BQU0sS0FBSyxNQUFNLEVBQUU7b0JB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LFlBQVksQ0FBQyxFQUN2QixVQUFVLENBQ1gsQ0FBQztpQkFDSDtnQkFDRCxNQUFNLE1BQU0sQ0FBQyxLQUFLLENBQUM7YUFDcEI7U0FDRjthQUFNO1lBQ0wsSUFBSSxPQUFPLEdBQUcsU0FBUyxHQUFHLElBQUksR0FBRyxJQUFJLEVBQUU7Z0JBQ3JDLElBQUksU0FBUyxFQUFFO29CQUNiLE9BQU8sQ0FBQyxLQUFLLENBQ1gsb0JBQW9CLEVBQ3BCLGdCQUFnQixFQUNoQixTQUFTLENBQUMsT0FBTyxDQUFDLEVBQ2xCLFVBQVUsQ0FDWCxDQUFDO2lCQUNIO2dCQUNELE9BQU8sY0FBYyxDQUFDO2FBQ3ZCO2lCQUFNLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDbEIsSUFBSSxTQUFTLEVBQUU7b0JBQ2IsT0FBTyxDQUFDLEtBQUssQ0FDWCxvQkFBb0IsRUFDcEIseUNBQXlDLEVBQ3pDLFNBQVMsRUFDVCx3QkFBd0IsRUFDeEIsU0FBUyxDQUFDLFlBQVksQ0FBQyxFQUN2QixVQUFVLENBQ1gsQ0FBQztpQkFDSDtnQkFDRCxNQUFNLE1BQU0sQ0FBQyxLQUFLLENBQUM7YUFDcEI7U0FDRjtRQUNELElBQUksU0FBUyxFQUFFO1lBQ2IsT0FBTyxDQUFDLEtBQUssQ0FDWCxvQkFBb0IsRUFDcEIsU0FBUyxFQUNULFNBQVMsQ0FBQyxPQUFPLENBQUMsRUFDbEIscUNBQXFDLEVBQ3JDLENBQUMsR0FBRyxDQUFDLEVBQ0wsT0FBTyxDQUNSLENBQUM7U0FDSDtRQUNELE1BQU0sQ0FBQyxLQUFLLEdBQUcsY0FBYyxDQUFDO0tBQy9CO0lBQ0QsSUFBSSxTQUFTLEVBQUU7UUFDYixPQUFPLENBQUMsS0FBSyxDQUFDLHFDQUFxQyxDQUFDLENBQUM7S0FDdEQ7SUFDRCxNQUFNLEVBQUUsQ0FBQztBQUNYLENBQUUsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlbmRlcmVyMiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRGF0YVVybCB9IGZyb20gJy4vbW9kZWxzL2RhdGEtdXJsJztcbmltcG9ydCB7IERPQ19PUklFTlRBVElPTiB9IGZyb20gJy4vbW9kZWxzL0RPQ19PUklFTlRBVElPTic7XG5pbXBvcnQgeyBVcGxvYWRSZXNwb25zZSB9IGZyb20gJy4vbW9kZWxzL3VwbG9hZC1yZXNwb25zZSc7XG5cbmV4cG9ydCBjbGFzcyBJbWFnZUNvbXByZXNzIHtcbiAgc3RhdGljIGdldE9yaWVudGF0aW9uID0gKGZpbGU6IEZpbGUpOiBQcm9taXNlPERPQ19PUklFTlRBVElPTj4gPT5cbiAgICBuZXcgUHJvbWlzZTxET0NfT1JJRU5UQVRJT04+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XG4gICAgICAgIHJlYWRlci5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICAgICAgY29uc3QgdmlldyA9IG5ldyBEYXRhVmlldyhyZWFkZXIucmVzdWx0IGFzIEFycmF5QnVmZmVyKTtcbiAgICAgICAgICBpZiAoIXZpZXcuYnl0ZUxlbmd0aCkge1xuICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoRE9DX09SSUVOVEFUSU9OLk5vdERlZmluZWQpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAodmlldy5nZXRVaW50MTYoMCwgZmFsc2UpICE9PSAweGZmZDgpIHtcbiAgICAgICAgICAgIHJldHVybiByZXNvbHZlKERPQ19PUklFTlRBVElPTi5Ob3REZWZpbmVkKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgY29uc3QgbGVuZ3RoID0gdmlldy5ieXRlTGVuZ3RoO1xuICAgICAgICAgIGxldCBvZmZzZXQgPSAyO1xuICAgICAgICAgIHdoaWxlIChvZmZzZXQgPCBsZW5ndGgpIHtcbiAgICAgICAgICAgIGNvbnN0IG1hcmtlciA9IHZpZXcuZ2V0VWludDE2KG9mZnNldCwgZmFsc2UpO1xuICAgICAgICAgICAgb2Zmc2V0ICs9IDI7XG4gICAgICAgICAgICBpZiAobWFya2VyID09PSAweGZmZTEpIHtcbiAgICAgICAgICAgICAgaWYgKHZpZXcuZ2V0VWludDMyKChvZmZzZXQgKz0gMiksIGZhbHNlKSAhPT0gMHg0NTc4Njk2Nikge1xuICAgICAgICAgICAgICAgIHJldHVybiByZXNvbHZlKERPQ19PUklFTlRBVElPTi5Ob3RKcGVnKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBjb25zdCBsaXR0bGUgPSB2aWV3LmdldFVpbnQxNigob2Zmc2V0ICs9IDYpLCBmYWxzZSkgPT09IDB4NDk0OTtcbiAgICAgICAgICAgICAgb2Zmc2V0ICs9IHZpZXcuZ2V0VWludDMyKG9mZnNldCArIDQsIGxpdHRsZSk7XG4gICAgICAgICAgICAgIGNvbnN0IHRhZ3MgPSB2aWV3LmdldFVpbnQxNihvZmZzZXQsIGxpdHRsZSk7XG4gICAgICAgICAgICAgIG9mZnNldCArPSAyO1xuICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRhZ3M7IGkrKykge1xuICAgICAgICAgICAgICAgIGlmICh2aWV3LmdldFVpbnQxNihvZmZzZXQgKyBpICogMTIsIGxpdHRsZSkgPT09IDB4MDExMikge1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUodmlldy5nZXRVaW50MTYob2Zmc2V0ICsgaSAqIDEyICsgOCwgbGl0dGxlKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgaWYgKChtYXJrZXIgJiAweGZmMDApICE9PSAweGZmMDApIHtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBvZmZzZXQgKz0gdmlldy5nZXRVaW50MTYob2Zmc2V0LCBmYWxzZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiByZXNvbHZlKERPQ19PUklFTlRBVElPTi5Ob3RKcGVnKTtcbiAgICAgICAgfTtcbiAgICAgICAgcmVhZGVyLnJlYWRBc0FycmF5QnVmZmVyKGZpbGUpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICByZXR1cm4gcmVqZWN0KERPQ19PUklFTlRBVElPTi5EZWZhdWx0KTtcbiAgICAgIH1cbiAgICB9KTtcblxuICBzdGF0aWMgdXBsb2FkRmlsZSA9IChcbiAgICByZW5kZXI6IFJlbmRlcmVyMixcbiAgICBtdWx0aXBsZTogYm9vbGVhbiA9IHRydWVcbiAgKTogUHJvbWlzZTxVcGxvYWRSZXNwb25zZSB8IFVwbG9hZFJlc3BvbnNlW10+ID0+XG4gICAgbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgY29uc3QgaXNTYWZhcmkgPSAvXigoPyFjaHJvbWV8YW5kcm9pZCkuKSpzYWZhcmkvaS50ZXN0KFxuICAgICAgICBuYXZpZ2F0b3IudXNlckFnZW50XG4gICAgICApO1xuXG4gICAgICBQcm9taXNlLnJlc29sdmUoaXNTYWZhcmkpXG4gICAgICAgIC50aGVuKChvbmx5TmF0aXZlKSA9PiB7XG4gICAgICAgICAgaWYgKG9ubHlOYXRpdmUpIHtcbiAgICAgICAgICAgIHJldHVybiBJbWFnZUNvbXByZXNzLmdlbmVyYXRlVXBsb2FkSW5wdXROYXRpdmUoXG4gICAgICAgICAgICAgIHdpbmRvdy5kb2N1bWVudCxcbiAgICAgICAgICAgICAgbXVsdGlwbGVcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBJbWFnZUNvbXByZXNzLmdlbmVyYXRlVXBsb2FkSW5wdXRSZW5kZXJlcihyZW5kZXIsIG11bHRpcGxlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICAgIC50aGVuKChmaWxlc0xpc3Q6IEZpbGVMaXN0IHwgbnVsbCkgPT4ge1xuICAgICAgICAgIGNvbnN0IGZpbGVzID0gZmlsZXNMaXN0ID8gQXJyYXkuZnJvbShmaWxlc0xpc3QpIDogW107XG4gICAgICAgICAgY29uc3Qgb3JpZW50YXRpb25Qcm9taXNlcyA9IGZpbGVzLm1hcCgoZmlsZSkgPT5cbiAgICAgICAgICAgIEltYWdlQ29tcHJlc3MuZ2V0T3JpZW50YXRpb24oZmlsZSlcbiAgICAgICAgICApO1xuICAgICAgICAgIGNvbnN0IHJlYWRlclByb21pc2VzID0gZmlsZXMubWFwKChmaWxlKSA9PlxuICAgICAgICAgICAgSW1hZ2VDb21wcmVzcy5maWxlVG9EYXRhVVJMKGZpbGUpXG4gICAgICAgICAgKTtcblxuICAgICAgICAgIGxldCBvcmllbnRhdGlvbnNSZXN1bHQ6IERPQ19PUklFTlRBVElPTltdID0gW107XG5cbiAgICAgICAgICBQcm9taXNlLmFsbChvcmllbnRhdGlvblByb21pc2VzKVxuICAgICAgICAgICAgLnRoZW4oKG9yaWVudGF0aW9uczogRE9DX09SSUVOVEFUSU9OW10pID0+IHtcbiAgICAgICAgICAgICAgb3JpZW50YXRpb25zUmVzdWx0ID0gb3JpZW50YXRpb25zO1xuICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwocmVhZGVyUHJvbWlzZXMpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC50aGVuKChyZWFkZXJSZXN1bHQpID0+IHtcbiAgICAgICAgICAgICAgaWYgKG11bHRpcGxlKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gcmVhZGVyUmVzdWx0Lm1hcCgoaW1hZ2UsIGluZGV4KSA9PiAoe1xuICAgICAgICAgICAgICAgICAgaW1hZ2UsXG4gICAgICAgICAgICAgICAgICBvcmllbnRhdGlvbjogb3JpZW50YXRpb25zUmVzdWx0W2luZGV4XSxcbiAgICAgICAgICAgICAgICB9KSk7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlc29sdmUoe1xuICAgICAgICAgICAgICAgICAgaW1hZ2U6IHJlYWRlclJlc3VsdFswXSxcbiAgICAgICAgICAgICAgICAgIG9yaWVudGF0aW9uOiBvcmllbnRhdGlvbnNSZXN1bHRbMF0sXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9KTtcblxuICBzdGF0aWMgZmlsZVRvRGF0YVVSTCA9IChmaWxlOiBGaWxlKTogUHJvbWlzZTxzdHJpbmc+ID0+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8c3RyaW5nPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xuICAgICAgcmVhZGVyLm9ubG9hZCA9IChlOiBhbnkpID0+IHtcbiAgICAgICAgLy9teVJlYWRlci5vbmxvYWRlbmQgPSAocHJvZ3Jlc3NFdmVudDogUHJvZ3Jlc3NFdmVudDxGaWxlUmVhZGVyPilcbiAgICAgICAgcmVzb2x2ZShlLnRhcmdldC5yZXN1bHQpO1xuICAgICAgfTtcbiAgICAgIHRyeSB7XG4gICAgICAgIHJlYWRlci5yZWFkQXNEYXRhVVJMKGZpbGUpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICByZWplY3QoXG4gICAgICAgICAgYG5neC1pbWFnZS1jb21wcmVzcyAtIHByb2JhYmx5IG5vIGZpbGUgaGF2ZSBiZWVuIHNlbGVjdGVkOiAke2V9YFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH0pO1xuICB9O1xuXG4gIHN0YXRpYyBnZW5lcmF0ZVVwbG9hZElucHV0UmVuZGVyZXIgPSAoXG4gICAgcmVuZGVyOiBSZW5kZXJlcjIsXG4gICAgbXVsdGlwbGU6IGJvb2xlYW4gPSB0cnVlXG4gICkgPT5cbiAgICBuZXcgUHJvbWlzZTxGaWxlTGlzdCB8IG51bGw+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IGlucHV0RWxlbWVudCA9IHJlbmRlci5jcmVhdGVFbGVtZW50KCdpbnB1dCcpO1xuICAgICAgcmVuZGVyLnNldFN0eWxlKGlucHV0RWxlbWVudCwgJ2Rpc3BsYXknLCAnbm9uZScpO1xuICAgICAgcmVuZGVyLnNldFByb3BlcnR5KGlucHV0RWxlbWVudCwgJ3R5cGUnLCAnZmlsZScpO1xuICAgICAgcmVuZGVyLnNldFByb3BlcnR5KGlucHV0RWxlbWVudCwgJ2FjY2VwdCcsICdpbWFnZS8qJyk7XG5cbiAgICAgIGlmIChtdWx0aXBsZSkge1xuICAgICAgICByZW5kZXIuc2V0UHJvcGVydHkoaW5wdXRFbGVtZW50LCAnbXVsdGlwbGUnLCAndHJ1ZScpO1xuICAgICAgfVxuXG4gICAgICByZW5kZXIubGlzdGVuKGlucHV0RWxlbWVudCwgJ2NsaWNrJywgKCRldmVudDogTW91c2VFdmVudCkgPT4ge1xuICAgICAgICAoJGV2ZW50LnRhcmdldCBhcyBhbnkgYXMgSFRNTElucHV0RWxlbWVudCkudmFsdWUgPSAnJztcbiAgICAgIH0pO1xuXG4gICAgICByZW5kZXIubGlzdGVuKGlucHV0RWxlbWVudCwgJ2NoYW5nZScsICgkZXZlbnQpID0+IHtcbiAgICAgICAgY29uc3QgZmlsZXM6IEZpbGVMaXN0ID0gJGV2ZW50LnRhcmdldC5maWxlcztcbiAgICAgICAgcmVzb2x2ZShmaWxlcyk7XG4gICAgICB9KTtcbiAgICAgIGlucHV0RWxlbWVudC5jbGljaygpO1xuICAgIH0pO1xuXG4gIHN0YXRpYyBnZW5lcmF0ZVVwbG9hZElucHV0TmF0aXZlID0gKFxuICAgIGRvY3VtZW50TmF0aXZlQXBpOiBhbnksXG4gICAgbXVsdGlwbGU6IGJvb2xlYW4gPSB0cnVlXG4gICkgPT4ge1xuICAgIGxldCBsb2NrID0gZmFsc2U7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPEZpbGVMaXN0IHwgbnVsbD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgaW5wdXRFbGVtZW50ID0gZG9jdW1lbnROYXRpdmVBcGkuY3JlYXRlRWxlbWVudCgnaW5wdXQnKTtcbiAgICAgIGlucHV0RWxlbWVudC5pZCA9ICd1cGxvYWQtaW5wdXQnICsgbmV3IERhdGUoKTtcbiAgICAgIGlucHV0RWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuICAgICAgaW5wdXRFbGVtZW50LnNldEF0dHJpYnV0ZSgndHlwZScsICdmaWxlJyk7XG5cbiAgICAgIGlmIChtdWx0aXBsZSkge1xuICAgICAgICBpbnB1dEVsZW1lbnQuc2V0QXR0cmlidXRlKCdtdWx0aXBsZScsICd0cnVlJyk7XG4gICAgICB9XG5cbiAgICAgIGRvY3VtZW50TmF0aXZlQXBpLmJvZHkuYXBwZW5kQ2hpbGQoaW5wdXRFbGVtZW50KTtcblxuICAgICAgaW5wdXRFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoXG4gICAgICAgICdjaGFuZ2UnLFxuICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgbG9jayA9IHRydWU7XG4gICAgICAgICAgcmVzb2x2ZShpbnB1dEVsZW1lbnQuZmlsZXMpO1xuICAgICAgICAgIC8vIHJlbW92ZSBmcm9tIGRvbVxuICAgICAgICAgIGRvY3VtZW50TmF0aXZlQXBpLmJvZHkucmVtb3ZlQ2hpbGQoXG4gICAgICAgICAgICBkb2N1bWVudE5hdGl2ZUFwaS5nZXRFbGVtZW50QnlJZChpbnB1dEVsZW1lbnQuaWQpIGFzIE5vZGVcbiAgICAgICAgICApO1xuICAgICAgICB9LFxuICAgICAgICB7IG9uY2U6IHRydWUgfVxuICAgICAgKTtcblxuICAgICAgLy8gZmlsZSBibHVyXG4gICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcbiAgICAgICAgJ2ZvY3VzJyxcbiAgICAgICAgKCkgPT4ge1xuICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgaWYgKCFsb2NrICYmIGRvY3VtZW50TmF0aXZlQXBpLmdldEVsZW1lbnRCeUlkKGlucHV0RWxlbWVudC5pZCkpIHtcbiAgICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcignb25ibHVyJykpO1xuICAgICAgICAgICAgICAvLyByZW1vdmUgZnJvbSBkb21cbiAgICAgICAgICAgICAgZG9jdW1lbnROYXRpdmVBcGkuYm9keS5yZW1vdmVDaGlsZChcbiAgICAgICAgICAgICAgICBkb2N1bWVudE5hdGl2ZUFwaS5nZXRFbGVtZW50QnlJZChpbnB1dEVsZW1lbnQuaWQpIGFzIE5vZGVcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9LCAzMDApO1xuICAgICAgICB9LFxuICAgICAgICB7IG9uY2U6IHRydWUgfVxuICAgICAgKTtcblxuICAgICAgLy8gb3BlbiBmaWxlIHNlbGVjdCBib3hcbiAgICAgIGlucHV0RWxlbWVudC5jbGljaygpO1xuICAgIH0pO1xuICB9O1xuXG4gIHN0YXRpYyBjb21wcmVzcyA9IChcbiAgICBpbWFnZURhdGFVcmxTb3VyY2U6IERhdGFVcmwsXG4gICAgb3JpZW50YXRpb246IERPQ19PUklFTlRBVElPTixcbiAgICByZW5kZXI6IFJlbmRlcmVyMixcbiAgICByYXRpbzogbnVtYmVyID0gNTAsXG4gICAgcXVhbGl0eTogbnVtYmVyID0gNTAsXG4gICAgbWF4d2lkdGg6IG51bWJlciA9IDAsXG4gICAgbWF4aGVpZ2h0OiBudW1iZXIgPSAwXG4gICk6IFByb21pc2U8c3RyaW5nPiA9PlxuICAgIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgIHF1YWxpdHkgPSBxdWFsaXR5IC8gMTAwO1xuICAgICAgcmF0aW8gPSByYXRpbyAvIDEwMDtcbiAgICAgIGNvbnN0IHNvdXJjZUltYWdlID0gbmV3IEltYWdlKCk7XG5cbiAgICAgIC8vIGltcG9ydGFudCBmb3Igc2FmYXJpOiB3ZSBuZWVkIHRvIHdhaXQgZm9yIG9ubG9hZCBldmVudFxuICAgICAgc291cmNlSW1hZ2Uub25sb2FkID0gKCkgPT4ge1xuICAgICAgICBjb25zdCBjYW52YXM6IEhUTUxDYW52YXNFbGVtZW50ID0gcmVuZGVyLmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xuICAgICAgICBjb25zdCBjdHg6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCB8IG51bGwgPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKTtcblxuICAgICAgICBpZiAoIWN0eCkge1xuICAgICAgICAgIHJldHVybiByZWplY3QoYE5vIGNhbnZhcyBjb250ZXh0IGF2YWlsYWJsZWApO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHcgPSBzb3VyY2VJbWFnZS5uYXR1cmFsV2lkdGg7XG4gICAgICAgIGxldCBoID0gc291cmNlSW1hZ2UubmF0dXJhbEhlaWdodDtcblxuICAgICAgICBpZiAoIUNTUy5zdXBwb3J0cygnaW1hZ2Utb3JpZW50YXRpb24nLCAnZnJvbS1pbWFnZScpKSB7XG4gICAgICAgICAgaWYgKFxuICAgICAgICAgICAgb3JpZW50YXRpb24gPT09IERPQ19PUklFTlRBVElPTi5SaWdodCB8fFxuICAgICAgICAgICAgb3JpZW50YXRpb24gPT09IERPQ19PUklFTlRBVElPTi5MZWZ0XG4gICAgICAgICAgKSB7XG4gICAgICAgICAgICBjb25zdCB0ID0gdztcbiAgICAgICAgICAgIHcgPSBoO1xuICAgICAgICAgICAgaCA9IHQ7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHhyYXRpbyA9IG1heHdpZHRoID8gbWF4d2lkdGggLyB3IDogMTtcbiAgICAgICAgbGV0IHlyYXRpbyA9IG1heGhlaWdodCA/IG1heGhlaWdodCAvIGggOiAxO1xuICAgICAgICByYXRpbyA9IE1hdGgubWluKHJhdGlvLCB4cmF0aW8sIHlyYXRpbyk7XG4gICAgICAgIGNhbnZhcy53aWR0aCA9IHcgKiByYXRpbztcbiAgICAgICAgY2FudmFzLmhlaWdodCA9IGggKiByYXRpbztcblxuICAgICAgICBjb25zdCBUT19SQURJQU5TID0gTWF0aC5QSSAvIDE4MDtcblxuICAgICAgICBpZiAoXG4gICAgICAgICAgQ1NTLnN1cHBvcnRzKCdpbWFnZS1vcmllbnRhdGlvbicsICdmcm9tLWltYWdlJykgfHxcbiAgICAgICAgICBvcmllbnRhdGlvbiA9PT0gRE9DX09SSUVOVEFUSU9OLlVwXG4gICAgICAgICkge1xuICAgICAgICAgIGN0eC5kcmF3SW1hZ2Uoc291cmNlSW1hZ2UsIDAsIDAsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7XG4gICAgICAgIH0gZWxzZSBpZiAob3JpZW50YXRpb24gPT09IERPQ19PUklFTlRBVElPTi5SaWdodCkge1xuICAgICAgICAgIGN0eC5zYXZlKCk7XG4gICAgICAgICAgY3R4LnJvdGF0ZSg5MCAqIFRPX1JBRElBTlMpO1xuICAgICAgICAgIGN0eC50cmFuc2xhdGUoMCwgLWNhbnZhcy53aWR0aCk7XG4gICAgICAgICAgY3R4LmRyYXdJbWFnZShzb3VyY2VJbWFnZSwgMCwgMCwgY2FudmFzLmhlaWdodCwgY2FudmFzLndpZHRoKTtcbiAgICAgICAgICBjdHgucmVzdG9yZSgpO1xuICAgICAgICB9IGVsc2UgaWYgKG9yaWVudGF0aW9uID09PSBET0NfT1JJRU5UQVRJT04uTGVmdCkge1xuICAgICAgICAgIGN0eC5zYXZlKCk7XG4gICAgICAgICAgY3R4LnJvdGF0ZSgtOTAgKiBUT19SQURJQU5TKTtcbiAgICAgICAgICBjdHgudHJhbnNsYXRlKC1jYW52YXMud2lkdGgsIDApO1xuICAgICAgICAgIGN0eC5kcmF3SW1hZ2Uoc291cmNlSW1hZ2UsIDAsIDAsIGNhbnZhcy5oZWlnaHQsIGNhbnZhcy53aWR0aCk7XG4gICAgICAgICAgY3R4LnJlc3RvcmUoKTtcbiAgICAgICAgfSBlbHNlIGlmIChvcmllbnRhdGlvbiA9PT0gRE9DX09SSUVOVEFUSU9OLkRvd24pIHtcbiAgICAgICAgICBjdHguc2F2ZSgpO1xuICAgICAgICAgIGN0eC5yb3RhdGUoMTgwICogVE9fUkFESUFOUyk7XG4gICAgICAgICAgY3R4LnRyYW5zbGF0ZSgtY2FudmFzLndpZHRoLCAtY2FudmFzLmhlaWdodCk7XG4gICAgICAgICAgY3R4LmRyYXdJbWFnZShzb3VyY2VJbWFnZSwgMCwgMCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTtcbiAgICAgICAgICBjdHgucmVzdG9yZSgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIC8vIG5vIG9yaWVudGF0aW9uIHZhbHVlIGZvdW5kIC0gc2FtZSBhcyBkZWZhdWx0IFVQXG4gICAgICAgICAgY3R4LmRyYXdJbWFnZShzb3VyY2VJbWFnZSwgMCwgMCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG1pbWUgPSBpbWFnZURhdGFVcmxTb3VyY2Uuc3Vic3RyKFxuICAgICAgICAgIDUsXG4gICAgICAgICAgaW1hZ2VEYXRhVXJsU291cmNlLnNwbGl0KCc7JylbMF0ubGVuZ3RoIC0gNVxuICAgICAgICApO1xuICAgICAgICAvLyBUT0RPIHRlc3Qgb24gbWltZVxuICAgICAgICBjb25zdCByZXN1bHQgPSBjYW52YXMudG9EYXRhVVJMKG1pbWUsIHF1YWxpdHkpO1xuXG4gICAgICAgIHJlc29sdmUocmVzdWx0KTtcbiAgICAgIH07XG5cbiAgICAgIHNvdXJjZUltYWdlLm9uZXJyb3IgPSAoZSkgPT4gcmVqZWN0KGUpO1xuICAgICAgc291cmNlSW1hZ2Uuc3JjID0gaW1hZ2VEYXRhVXJsU291cmNlO1xuICAgIH0pO1xuXG4gIHN0YXRpYyBieXRlQ291bnQgPSAoaW1nU3RyaW5nOiBEYXRhVXJsKTogbnVtYmVyID0+XG4gICAgZW5jb2RlVVJJKGltZ1N0cmluZykuc3BsaXQoLyUuLnwuLykubGVuZ3RoIC0gMTtcblxuICBzdGF0aWMgZ2V0SW1hZ2VNYXhTaXplID0gYXN5bmMgKFxuICAgIG1heFNpemVNYjogbnVtYmVyLFxuICAgIGRlYnVnTW9kZTogYm9vbGVhbixcbiAgICByZW5kZXI6IFJlbmRlcmVyMlxuICApOiBQcm9taXNlPERhdGFVcmw+ID0+IHtcbiAgICBjb25zdCBNQVhfVFJJRVMgPSAxMDtcblxuICAgIGNvbnN0IGJ5dGVzVG9NQiA9IChieXRlczogbnVtYmVyKSA9PiAoYnl0ZXMgLyAxMDI0IC8gMTAyNCkudG9GaXhlZCgyKTtcblxuICAgIGlmIChkZWJ1Z01vZGUpIHtcbiAgICAgIGNvbnNvbGUuZGVidWcoJ05neEltYWdlQ29tcHJlc3MgLSBPcGVuaW5nIHVwbG9hZCB3aW5kb3cnKTtcbiAgICB9XG5cbiAgICBsZXQgbXlGaWxlOiBVcGxvYWRSZXNwb25zZSA9IChhd2FpdCBJbWFnZUNvbXByZXNzLnVwbG9hZEZpbGUoXG4gICAgICByZW5kZXIsXG4gICAgICBmYWxzZVxuICAgICkpIGFzIFVwbG9hZFJlc3BvbnNlO1xuXG4gICAgbGV0IGNvbXByZXNzZWRGaWxlO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBNQVhfVFJJRVM7IGkrKykge1xuICAgICAgY29uc3QgcHJldmlvdXNTaXplID0gSW1hZ2VDb21wcmVzcy5ieXRlQ291bnQobXlGaWxlLmltYWdlKTtcbiAgICAgIGNvbXByZXNzZWRGaWxlID0gYXdhaXQgSW1hZ2VDb21wcmVzcy5jb21wcmVzcyhcbiAgICAgICAgbXlGaWxlLmltYWdlLFxuICAgICAgICBteUZpbGUub3JpZW50YXRpb24sXG4gICAgICAgIHJlbmRlcixcbiAgICAgICAgNTAsXG4gICAgICAgIDEwMFxuICAgICAgKTtcbiAgICAgIGNvbnN0IG5ld1NpemUgPSBJbWFnZUNvbXByZXNzLmJ5dGVDb3VudChjb21wcmVzc2VkRmlsZSk7XG4gICAgICBjb25zb2xlLmRlYnVnKFxuICAgICAgICAnTmd4SW1hZ2VDb21wcmVzcyAtJyxcbiAgICAgICAgJ0NvbXByZXNzaW9uIGZyb20nLFxuICAgICAgICBieXRlc1RvTUIocHJldmlvdXNTaXplKSxcbiAgICAgICAgJ01CIHRvJyxcbiAgICAgICAgYnl0ZXNUb01CKG5ld1NpemUpLFxuICAgICAgICAnTUInXG4gICAgICApO1xuICAgICAgaWYgKG5ld1NpemUgPj0gcHJldmlvdXNTaXplKSB7XG4gICAgICAgIGlmIChpID09PSAwKSB7XG4gICAgICAgICAgaWYgKGRlYnVnTW9kZSkge1xuICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhcbiAgICAgICAgICAgICAgJ05neEltYWdlQ29tcHJlc3MgLScsXG4gICAgICAgICAgICAgIFwiRmlsZSBjYW4ndCBiZSByZWR1Y2VkIGF0IGFsbCAtIHJldHVybmluZyB0aGUgb3JpZ2luYWxcIixcbiAgICAgICAgICAgICAgYnl0ZXNUb01CKHByZXZpb3VzU2l6ZSksXG4gICAgICAgICAgICAgICdNQiBsYXJnZSdcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHRocm93IG15RmlsZS5pbWFnZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAoZGVidWdNb2RlKSB7XG4gICAgICAgICAgICBjb25zb2xlLmRlYnVnKFxuICAgICAgICAgICAgICAnTmd4SW1hZ2VDb21wcmVzcyAtJyxcbiAgICAgICAgICAgICAgXCJGaWxlIGNhbid0IGJlIHJlZHVjZWQgbW9yZSAtIHJldHVybmluZyB0aGUgYmVzdCB3ZSBjYW4sIHdoaWNoIGlzIFwiLFxuICAgICAgICAgICAgICBieXRlc1RvTUIocHJldmlvdXNTaXplKSxcbiAgICAgICAgICAgICAgJ01CIGxhcmdlJ1xuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhyb3cgbXlGaWxlLmltYWdlO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAobmV3U2l6ZSA8IG1heFNpemVNYiAqIDEwMjQgKiAxMDI0KSB7XG4gICAgICAgICAgaWYgKGRlYnVnTW9kZSkge1xuICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhcbiAgICAgICAgICAgICAgJ05neEltYWdlQ29tcHJlc3MgLScsXG4gICAgICAgICAgICAgICdIZXJlIHlvdXIgZmlsZScsXG4gICAgICAgICAgICAgIGJ5dGVzVG9NQihuZXdTaXplKSxcbiAgICAgICAgICAgICAgJ01CIGxhcmdlJ1xuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIGNvbXByZXNzZWRGaWxlO1xuICAgICAgICB9IGVsc2UgaWYgKGkgPT09IDkpIHtcbiAgICAgICAgICBpZiAoZGVidWdNb2RlKSB7XG4gICAgICAgICAgICBjb25zb2xlLmRlYnVnKFxuICAgICAgICAgICAgICAnTmd4SW1hZ2VDb21wcmVzcyAtJyxcbiAgICAgICAgICAgICAgXCJGaWxlIGNhbid0IHJlYWNoIHRoZSBkZXNpcmVkIHNpemUgYWZ0ZXJcIixcbiAgICAgICAgICAgICAgTUFYX1RSSUVTLFxuICAgICAgICAgICAgICAndHJpZXMuIFJldHVybmluZyBmaWxlICcsXG4gICAgICAgICAgICAgIGJ5dGVzVG9NQihwcmV2aW91c1NpemUpLFxuICAgICAgICAgICAgICAnTUIgbGFyZ2UnXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aHJvdyBteUZpbGUuaW1hZ2U7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChkZWJ1Z01vZGUpIHtcbiAgICAgICAgY29uc29sZS5kZWJ1ZyhcbiAgICAgICAgICAnTmd4SW1hZ2VDb21wcmVzcyAtJyxcbiAgICAgICAgICAnUmVhY2hlZCcsXG4gICAgICAgICAgYnl0ZXNUb01CKG5ld1NpemUpLFxuICAgICAgICAgICdNQiBsYXJnZS4gVHJ5aW5nIGFub3RoZXIgdGltZSBhZnRlcicsXG4gICAgICAgICAgaSArIDEsXG4gICAgICAgICAgJ3RpbWVzJ1xuICAgICAgICApO1xuICAgICAgfVxuICAgICAgbXlGaWxlLmltYWdlID0gY29tcHJlc3NlZEZpbGU7XG4gICAgfVxuICAgIGlmIChkZWJ1Z01vZGUpIHtcbiAgICAgIGNvbnNvbGUuZGVidWcoJ05neEltYWdlQ29tcHJlc3MgLSBVbmV4cGVjdGVkIGVycm9yJyk7XG4gICAgfVxuICAgIHRocm93ICcnO1xuICB9O1xufVxuIl19